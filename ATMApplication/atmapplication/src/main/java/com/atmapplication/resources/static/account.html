<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATM Interface</title>
    <!-- <link rel="stylesheet" href="/css/accountStyle.css"> -->
    <!-- <script src="/javascript/script.js"></script> -->
<style>
    body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f0f0f0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
}

#container {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    width: 420px;
    text-align: center;
    margin: 20px;
    height: 500px;
}

h1 {
    color: #333;
    margin-top: 0px;
}

h2 {
    margin-top: 20px;
    color: #555;
}

input[type="number"] {
    width: 90%;
    padding: 8px;
    margin: 5px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
}

button {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 10px 20px;
    cursor: pointer;
}

button:hover {
    background-color: #0056b3;
}

#transactionHistoryContainer {
    display: none;
    margin-top: 20px;
    padding-top: 10px;
    border-top: 1px solid #ccc;
}

#transactionHistoryContainer {
    display: block;
    margin-top: 5px;
    padding-top: 10px;
    border-top: 1px solid #ccc;
    max-height: 40px; 
    overflow: auto;
}
</style>
</head>
<body>
    <div id="container">
        <h1>ATM Interface</h1>
        <div id="balance">Balance: $<span id="currentBalance">{{initialBalance}}</span></div>
        <h2>Deposit Funds</h2>
        <input type="number" id="depositAmount" placeholder="Enter deposit amount">
        <button onclick="deposit()">Deposit</button>
        
        <h2>Withdraw Funds</h2>
        <input type="number" id="withdrawAmount" placeholder="Enter withdrawal amount">
        <button onclick="withdraw()">Withdraw</button>

        <h3>Show Transaction History</h3>
        <div id="transactionHistoryContainer"></div>
        <button id="showTransactionHistory">Show Transaction History</button>
    </div>
<script>
    let balance;
// Extract the account number from the URL query parameters
const urlSearchParams = new URLSearchParams(window.location.search);
const loggedInAccountNumber = urlSearchParams.get("accountNumber");

// Fetch the account page for the logged-in account
fetch(`/account?accountNumber=${loggedInAccountNumber}`)
.then(response => response.text())
.then(html => {
    document.body.innerHTML = html;
    balance = parseFloat(document.getElementById("currentBalance").textContent); // Get the initial balance from the page
    updateBalance(); // Initialize the balance display

    // Now that the account page is loaded, get references to the other elements
    const showTransactionHistoryButton = document.getElementById("showTransactionHistory");
    const transactionHistoryContainer = document.getElementById("transactionHistoryContainer");

    // Attach the click event handler after getting the button reference
    showTransactionHistoryButton.addEventListener("click", handleTransactionHistoryButtonClick);
})
.catch(error => console.error('Error fetching account page:', error));


function updateBalance() {
    document.getElementById("currentBalance").textContent = balance;
}
    
function deposit() {
    const depositAmount = parseFloat(document.getElementById("depositAmount").value);
    if (!isNaN(depositAmount) && depositAmount > 0) {
        fetch(`/deposit?accountNumber=${loggedInAccountNumber}&depositAmount=${depositAmount}`, { 
            method: "POST"
        })
        .then(response => response.text())
        .then(message => {
            if (message === "Deposited successfully") {
                balance += depositAmount;
                updateBalance();
                alert(`Deposited $${depositAmount}`);
            } else {
                alert("Account not found");
            }
        })
        .catch(error => console.error('Error depositing funds:', error));
    } else {
        alert("Invalid deposit amount");
    }
}

function withdraw() {
    const withdrawAmount = parseFloat(document.getElementById("withdrawAmount").value);
    if (!isNaN(withdrawAmount) && withdrawAmount > 0) {
        fetch(`/withdraw?accountNumber=${loggedInAccountNumber}&withdrawAmount=${withdrawAmount}`, {
            method: "POST"
        })
        .then(response => response.text())
        .then(message => {
            if (message === "Withdrawn successfully") {
                if (withdrawAmount <= balance) {
                    balance -= withdrawAmount;
                    updateBalance();
                    alert(`Withdrawn $${withdrawAmount}`);
                } else {
                    alert("Insufficient balance");
                }
            } else {
                alert("Account not found");
            }
        })
        .catch(error => console.error('Error withdrawing funds:', error));
    } else {
        alert("Invalid withdrawal amount");
    }
}

updateBalance(); // Initialize the balance display

function handleTransactionHistoryButtonClick() {
    console.log("Button clicked");
    // Toggle the visibility of the transaction history container
    if (transactionHistoryContainer.style.display === "none") {
        transactionHistoryContainer.style.display = "block";
        fetchTransactionHistory(); // Fetch and display the transaction history
        console.log("Fetching transaction history");
    } else {
        transactionHistoryContainer.style.display = "none";
    }
}

function fetchTransactionHistory() {
    // Fetch recent transactions
    fetch(`/transaction-history?accountNumber=${loggedInAccountNumber}`)
        .then(response => response.json())
        .then(transactions => {
            console.log(transactions)
            // Generate the transaction history HTML
            const transactionHistoryHTML = transactions.map(transaction => `
                <p>${transaction.type} of $${transaction.amount} at ${new Date(transaction.localDateTime).toLocaleString()}</p>
            `).join('');
            console.log(transactionHistoryHTML);
            // Insert the transaction history HTML into the container
            transactionHistoryContainer.innerHTML = transactionHistoryHTML;
            console.log(transactionHistoryContainer.innerHTML);
        })
        .catch(error => console.error('Error fetching transaction history:', error));
}
</script>
</body>
</html>
